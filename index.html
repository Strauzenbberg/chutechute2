<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üî¢ ChuteChute ‚Äî Leaderboard Global</title>
  <meta name="description" content="Jogo de adivinhar n√∫mero com leaderboard global via Google Apps Script (CORS-safe)." />
  <style>
    :root{--bg:#ffffff;--fg:#222;--accent:#0B3B60;--muted:#666;--card:#f7f7f7;--border:#e6eef5}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg);padding:20px}
    .wrap{max-width:920px;margin:0 auto}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:.95rem}
    input,select{padding:8px;border-radius:8px;border:1px solid #d0d7e2;background:#fff;color:var(--fg)}
    input[type="number"]{width:160px}
    input[type="text"]{width:180px}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    button.secondary{background:#5f6b7a}
    .muted{color:var(--muted);font-size:.92rem}
    .notice{background:#fff3cd;border:1px solid #ffe69c;color:#8a6d3b;padding:8px;border-radius:8px;margin-top:8px}
    #recordsList{display:grid;gap:8px;margin-top:8px}
    .record{display:flex;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #e0e0e0;background:#fff}
    .hidden{display:none!important}
    @media (max-width:560px){ .record{flex-direction:column;gap:4px} input[type="text"],input[type="number"]{width:130px} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üî¢ ChuteChute ‚Äî Leaderboard Global</h1>

    <div class="card">
      <div class="row">
        <label>Nome <input id="playerName" type="text" placeholder="Seu nome (opcional)" /></label>
        <label>Dificuldade
          <select id="difficulty">
            <option value="easy">F√°cil (1‚Äì50)</option>
            <option value="medium" selected>M√©dio (1‚Äì100)</option>
            <option value="hard">Dif√≠cil (1‚Äì200)</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="guess" type="number" placeholder="Seu palpite" />
        <button id="btnGuess">Verificar</button>
        <button id="btnRestart" class="secondary hidden">Jogar Novamente</button>
      </div>

      <div id="message" class="muted" style="margin-top:10px"></div>

      <div id="netNotice" class="notice hidden"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>üèÖ Top 10 Global</strong>
          <div class="muted">Ordenado por menos tentativas (desempate pela data mais recente).</div>
        </div>
        <button id="btnRefresh" class="secondary">Atualizar</button>
      </div>

      <div id="recordsList" class="muted">Carregando...</div>
    </div>
  </div>

  <script>
    // URL do seu Apps Script publicado como Web App (Who has access: Anyone)
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbtOhk4-2QISmZ2L7_b0q5jBAAaDXO8AsZTows7VeQeIzjnUxlu2RGbAE6-Uo3GRnh/exec';

    // Jogo
    const DIFFICULTIES = { easy:50, medium:100, hard:200 };
    let difficulty = 'medium';
    let max = DIFFICULTIES[difficulty];
    let secret = Math.floor(Math.random()*max)+1;
    let attempts = 0;
    let finished = false;

    // DOM
    const playerNameEl = document.getElementById('playerName');
    const difficultyEl = document.getElementById('difficulty');
    const guessEl = document.getElementById('guess');
    const btnGuess = document.getElementById('btnGuess');
    const btnRestart = document.getElementById('btnRestart');
    const btnRefresh = document.getElementById('btnRefresh');
    const messageEl = document.getElementById('message');
    const netNoticeEl = document.getElementById('netNotice');
    const recordsListEl = document.getElementById('recordsList');

    // Helpers de rede (sem headers customizados; POST como text/plain para evitar preflight)
    async function fetchJSONNoCorsIssues(url) {
      const finalUrl = new URL(url);
      finalUrl.searchParams.set('_ts', String(Date.now()));
      try {
        const res = await fetch(finalUrl.toString(), { method: 'GET', mode: 'cors', cache: 'no-store' });
        const text = await res.text();
        return JSON.parse(text);
      } catch (err) {
        throw err;
      }
    }

    async function postJSONNoCorsIssues(url, payloadObj) {
      const bodyStr = JSON.stringify(payloadObj);
      const finalUrl = new URL(url);
      finalUrl.searchParams.set('_ts', String(Date.now()));
      // Content-Type: text/plain evita preflight (OPTIONS)
      const res = await fetch(finalUrl.toString(), {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        headers: { 'Content-Type': 'text/plain' },
        body: bodyStr
      });
      // Apps Script pode n√£o setar status; tentamos ler body sempre
      const text = await res.text();
      // Ignora parsing se n√£o for JSON v√°lido; n√£o quebra o fluxo
      try { return JSON.parse(text); } catch { return { ok: true }; }
    }

    function showNetNotice(msg) {
      netNoticeEl.textContent = msg;
      netNoticeEl.classList.remove('hidden');
      setTimeout(() => netNoticeEl.classList.add('hidden'), 5000);
    }

    // Leaderboard
    async function fetchRecords() {
      try {
        const data = await fetchJSONNoCorsIssues(WEB_APP_URL);
        renderTop10(data);
      } catch (err) {
        recordsListEl.textContent = 'Erro ao carregar leaderboard.';
        showNetNotice('Falha ao buscar records: ' + (err?.message || err));
      }
    }

    function renderTop10(arr) {
      if (!Array.isArray(arr) || arr.length === 0) {
        recordsListEl.textContent = 'Nenhum recorde.';
        return;
      }
      const sorted = arr
        .slice()
        .sort((a,b)=> {
          if (a.tries !== b.tries) return a.tries - b.tries;
          return new Date(b.date) - new Date(a.date);
        })
        .slice(0,10);
      recordsListEl.innerHTML = '';
      sorted.forEach((r,i)=>{
        const div = document.createElement('div');
        div.className = 'record';
        const nameSafe = (r.name && String(r.name)) || '‚Äî';
        const diffLabel = (r.difficulty || '').toString().toUpperCase();
        const dateLabel = r.date ? new Date(r.date).toLocaleString() : '';
        div.innerHTML =
          `<div><strong>#${i+1}</strong> ${nameSafe} <span class="muted">(${diffLabel})</span></div>` +
          `<div class="muted">${r.tries} tentativa(s) ‚Ä¢ ${dateLabel}</div>`;
        recordsListEl.appendChild(div);
      });
    }

    async function pushRecord(record) {
      try {
        await postJSONNoCorsIssues(WEB_APP_URL, record);
        await fetchRecords();
      } catch (err) {
        showNetNotice('Falha ao enviar record: ' + (err?.message || err));
      }
    }

    // Jogo
    function startGame() {
      difficulty = difficultyEl.value;
      max = DIFFICULTIES[difficulty];
      secret = Math.floor(Math.random()*max)+1;
      attempts = 0;
      finished = false;
      messageEl.textContent = `Escolha um n√∫mero entre 1 e ${max}`;
      guessEl.value = '';
      btnRestart.classList.add('hidden');
      guessEl.min = 1;
      guessEl.max = max;
      guessEl.focus(); guessEl.select();
    }

    async function handleGuess() {
      if (finished) return;
      const val = parseInt(guessEl.value, 10);
      if (!Number.isFinite(val) || val < 1 || val > max) {
        messageEl.textContent = `Insira um n√∫mero entre 1 e ${max}.`;
        guessEl.focus(); guessEl.select();
        return;
      }
      attempts++;
      if (val === secret) {
        messageEl.textContent = `üéâ Acertou em ${attempts} tentativa(s)! Enviando...`;
        finished = true;
        const rec = {
          name: (playerNameEl.value || '').trim() || null,
          tries: attempts,
          difficulty,
          max,
          date: new Date().toISOString()
        };
        await pushRecord(rec);
        btnRestart.classList.remove('hidden');
      } else {
        messageEl.textContent = val < secret ? 'üîº Muito baixo!' : 'üîΩ Muito alto!';
      }
      guessEl.focus(); guessEl.select();
    }

    // Eventos
    btnGuess.addEventListener('click', handleGuess);
    btnRestart.addEventListener('click', startGame);
    difficultyEl.addEventListener('change', startGame);
    guessEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handleGuess(); });
    btnRefresh.addEventListener('click', fetchRecords);

    // Inicializa√ß√£o
    (async function init(){
      startGame();
      await fetchRecords();
      setInterval(fetchRecords, 10000);
    })();
  </script>
</body>
</html>
